---
title: "hw4"
output: html_document
date: "2024-11-19"
---
# 0. Contribution Statement
Student 1:

Student 2:
#Introduction
Monitoring water supply in the Sierra Nevada mountains of Northern California is critical, particularly during winter when snowpacks serve as a major source of water. To measure snow density, a gamma transmission snow gauge is used, which estimates density indirectly by detecting gamma ray emissions. The gauge's calibration process involves placing polyethylene blocks of known densities between the gauge poles and recording the corresponding gamma ray intensity, referred to as the "gain." This calibration ensures that measured gamma intensities can be accurately mapped to snow densities in real-world applications.

The relationship between density and gamma ray intensity follows an exponential decay pattern, described by the equation g=Ae^(βd), where g is the gain, d is the density, and A and β are parameters determined during calibration. The primary objective of this study is to establish and evaluate a reliable relationship between measured gamma intensities and snow density, enabling accurate calibration and predictions for practical use.

```{r}
data <- read.table("gauge.txt", header = TRUE)
data
```


## Question1
### Method
Methods The data shows a relationship between gain and density, described by  , suggesting an exponential decay. To verify this, a linear regression was performed on the untransformed data, and the residuals were examined to assess model adequacy. 
### Analysis
```{r}
linear_model <- lm(gain ~ density, data = data)
summary(linear_model)
```

```{r}
plot(data$density,data$gain,xlab = 'Density', ylab = 'Gain', main = 'Linear Fit of Gain vs. Density')
abline(linear_model, col = "red", lwd = 2)

```
```{r}
plot(linear_model$fitted.values, resid(linear_model), 
     main = "Residuals vs Fitted Values", 
     xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red", lty = 2)
```
The linear regression of gain vs. density revealed a poor fit, as seen in the residual plot, where residuals exhibited a pronounced curvature rather than random scatter around zero. This suggests that the data does not follow a linear relationship. The exponential decay nature of the problem makes a log transformation of gain appropriate to convert the relationship into a linear form.

### Conclusion
The residual analysis confirms that a transformation is necessary to accurately model the relationship between gain and density. A log transformation of gain aligns with the theoretical exponential decay model, enabling a linear regression that better fits the data and produces random residuals, satisfying model assumptions.

## Question2
### Methods
The relationship between gamma ray gain and density was modeled using the exponential decay function g = Ae^(β x d) , consistent with the theoretical physics of gamma ray attenuation. The model was fitted using nonlinear least squares regression to estimate the parameters A (initial gain) and β (rate of decay). Residual analysis was performed to ensure model adequacy, and statistical significance of the parameters was assessed. The model's performance was further evaluated by comparing the fitted curve to observed data and analyzing residual patterns.

### Analysis
```{r}
# Nonlinear regression to fit g = A * exp(beta * d)
exp_model <- nls(gain ~ A * exp(beta * density), data = data, 
                 start = list(A = max(data$gain), beta = -5))  # Provide reasonable starting values

# Summarize the model
summary(exp_model)


```
```{r}
plot(data$density, data$gain,
     main = "Exponential Fit of Gain vs. Density",
     xlab = "Density", ylab = "Gain")

A <- coef(exp_model)["A"]
beta <- coef(exp_model)["beta"]

# Plot the exponential curve
curve(A * exp(beta * x), 
      from = min(data$density), to = max(data$density), 
      add = TRUE, col = "red", lwd = 2)
```

```{r}
residuals_exp <- resid(exp_model)

# Residuals vs Fitted Values Plot
plot(fitted(exp_model), residuals_exp,
     main = "Residuals vs Fitted Values (Exponential Model)",
     xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red", lty = 2)


```
Theoretical Justification:

The exponential decay function g=Ae βd aligns with the physics of gamma ray transmission, where denser materials attenuate rays at an exponential rate. This theoretical framework supports the choice of an exponential model over other forms, such as linear regression.
The parameter A represents the maximum gain when density is zero, while β describes the rate at which gain decreases as density increases, both of which are physically meaningful.

Empirical Evidence:

The fitted curve g= 430.12e^(−5.002d) closely matches the observed data, as shown in the exponential fit plot, demonstrating that the model effectively captures the relationship between gain and density. The residual plot shows a random scatter around zero, indicating no systematic errors or patterns, which confirms that the exponential model appropriately describes the data. Additionally, the parameters  A and β are highly statistically significant (p<2e^−16 ), and the residual standard error of 6.012 is low relative to the range of gain values, indicating a strong fit. The model also converged within two iterations with a small tolerance value, highlighting its numerical stability and further validating the appropriateness of the exponential decay form.


### Conclusion
The exponential model is justified both theoretically and empirically. Theoretically, it aligns with the principles of gamma ray attenuation, where exponential decay governs the relationship between material density and ray intensity. Empirically, the model fits the data well, with a fitted curve that closely follows observed points, random residuals indicating no systematic bias, and statistically significant parameters. This model is robust and suitable for mapping gain to density, making it a reliable tool for calibrating the gamma transmission snow gauge.



## Question3
### Methods
To evaluate the robustness of the exponential model to errors in density measurement, random normal noise with a standard deviation of 0.01 was added to the density values. The noisy density data were used to re-fit the exponential model using nonlinear least squares regression. Residuals from the original and noisy models were compared to assess the impact of density perturbation on model accuracy. Additionally, the fitted curves for both models were visually compared to evaluate deviations caused by the noise.

### Analysis
```{r}
set.seed(123) # For reproducibility

# Add random normal noise to density values
data$noisy_density <- data$density + rnorm(n = nrow(data), mean = 0, sd = 0.01) # Adjust sd as needed

# Fit the exponential model with noisy densities
noisy_exp_model <- nls(gain ~ A * exp(beta * noisy_density), data = data, 
                       start = list(A = 430, beta = -5))

# Summarize the model
summary(noisy_exp_model)



```
```{r}
# Residual comparison
par(mfrow = c(1, 2)) # Side-by-side plots
plot(fitted(noisy_exp_model), resid(noisy_exp_model), 
     main = "Residuals (Noisy Densities)", xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red", lty = 2)

plot(fitted(exp_model), resid(exp_model), 
     main = "Residuals (Original Densities)", xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red", lty = 2)

# Set up a side-by-side plotting layout
par(mfrow = c(1, 2)) # Two plots side by side

# Plot the original fitted model
plot(data$density, data$gain, 
     main = "Original Fitted Model", 
     xlab = "Density", ylab = "Gain", col = "blue")
curve(coef(exp_model)["A"] * exp(coef(exp_model)["beta"] * x), 
      add = TRUE, col = "red", lwd = 2, lty = 1) # Original model fit
legend("topright", legend = c("Original Fit"), col = "red", lty = 1, lwd = 2)

# Plot the noisy fitted model
plot(data$density, data$gain, 
     main = "Noisy Fitted Model", 
     xlab = "Density", ylab = "Gain", col = "blue")
curve(coef(noisy_exp_model)["A"] * exp(coef(noisy_exp_model)["beta"] * x), 
      add = TRUE, col = "red", lwd = 2, lty = 2) # Noisy model fit
legend("topright", legend = c("Noisy Fit"), col = "red", lty = 2, lwd = 2)
```

Introducing random noise to the density values slightly affected the model’s performance. The fitted curve for the noisy model g=432.36e −5.029d closely aligns with the original model g=430.12e −5.002d, with only minor deviations observed, particularly at higher densities. Residual plots for both the original and noisy models show a random scatter around zero, indicating no systematic errors or significant impact on model accuracy. However, the residual standard error increased from 6.012 to 8.583 in the noisy model, reflecting the effect of density perturbations. Despite this increase, the parameters A and β remained highly significant p<2e −16 , confirming the robustness of the exponential model.

### Conclusion
The exponential model is robust to small errors in density measurements, as shown by the minimal differences between the original and noisy fits. While the residual standard error increased slightly, the fitted curves remained closely aligned, and the random residual patterns indicated no systematic bias. This stability demonstrates that the model can handle practical scenarios where density measurements are subject to minor inaccuracies, ensuring reliable calibration and predictions in real-world applications.

## Question4

### Method

### Analysis

```{r}
# Function to calculate predicted gain and prediction intervals
predict_gain <- function(density, model, conf_level = 0.95) {
  # Extract parameters
  A <- coef(model)["A"]
  beta <- coef(model)["beta"]
  
  # Point estimate
  predicted_gain <- A * exp(beta * density)
  
  # Variance of the parameters
  param_var <- vcov(model)
  var_A <- param_var["A", "A"]
  var_beta <- param_var["beta", "beta"]
  cov_A_beta <- param_var["A", "beta"]
  
  # Standard error for the prediction
  se <- sqrt(
    (exp(beta * density))^2 * var_A +
      (A * density * exp(beta * density))^2 * var_beta +
      2 * (exp(beta * density)) * (A * density * exp(beta * density)) * cov_A_beta
  )
  
  # Critical value for the confidence interval
  z <- qnorm(1 - (1 - conf_level) / 2)
  
  # Prediction interval
  lower <- predicted_gain - z * se
  upper <- predicted_gain + z * se
  
  return(list(predicted_gain = predicted_gain, lower = lower, upper = upper))
}

```

```{r}
# Densities for prediction
densities <- c(0.508, 0.001)

# Use the function to calculate predictions and intervals
predictions <- lapply(densities, function(d) predict_gain(density = d, model = exp_model))

# Print results
for (i in seq_along(densities)) {
  cat(sprintf("Density: %.3f\n", densities[i]))
  cat(sprintf("Predicted Gain: %.2f\n", predictions[[i]]$predicted_gain))
  cat(sprintf("95%% Prediction Interval: [%.2f, %.2f]\n\n", predictions[[i]]$lower, predictions[[i]]$upper))
}

```
```{r}
# Create a curve for the model and overlay prediction points
plot(data$density, data$gain, 
     main = "Forward Prediction with Confidence Intervals", 
     xlab = "Density", ylab = "Gain", pch = 19, col = "blue")

curve(coef(exp_model)["A"] * exp(coef(exp_model)["beta"] * x), 
      from = min(data$density), to = max(data$density), 
      add = TRUE, col = "red", lwd = 2)

# Add prediction points and intervals
for (i in seq_along(densities)) {
  points(densities[i], predictions[[i]]$predicted_gain, col = "pink", pch = 19)
  arrows(densities[i], predictions[[i]]$lower, densities[i], predictions[[i]]$upper, 
         angle = 90, code = 3, length = 0.05, col = "pink")
}
legend("topright", legend = c("Fitted Model", "Prediction"), col = c("red", "pink"), 
       lty = 1, pch = c(NA, 19), bty = "n")

```
For a density of d = 0.508, the predicted gain is g=33.88 with a 95% prediction interval of (32.81,34.96). This interval closely aligns with the observed data range, demonstrating the model's accuracy for higher density values. Similarly, for d=0.001, the predicted gain is g=427.97 with a 95% prediction interval of (424.64,431.31), which also matches the observed range. The prediction intervals are narrower for d=0.508 due to the reduced variability at higher densities, while the interval for d=0.001 reflects slightly more variability in gain values at lower densities. This result highlights the model's capacity to provide reliable gain predictions and quantify uncertainty.

### Conclusion
Conclusion The exponential model accurately predicts gain across the range of densities, with prediction intervals closely matching the observed data. Gains for higher densities (d=0.508) are predicted with greater precision due to reduced variability, while predictions for lower densities (d=0.001) maintain accuracy but exhibit slightly wider intervals, reflecting the model's sensitivity to density variability. These findings confirm the model's reliability for forward predictions, ensuring accurate calibration of the gamma transmission snow gauge.



